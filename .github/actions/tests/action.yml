name: Java tests
description: Run Java SDKs tests

inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: false
  shell:
    description: shell to use
    type: string
    default: bash
    required: false
  module:
    description: module to test (core, appium, selenium, images, playwright, coverage-selenium, coverage-playwright)
    type: string
    required: true
  eg:
    description: Run on EG (Execution Cloud)
    type: boolean
    default: true
    required: true
  report:
    description: report level
    type: string
    default: sandbox
    required: false
  report-dir:
    description: report directory
    type: string
    default: java_sdk
    required: false

runs:
  using: composite
  steps:
    - name: Install dependencies
      working-directory: ${{inputs.working-directory}}
      shell: ${{inputs.shell}}
      run: |
        mvn clean install -DskipTests
        echo "UFG_ON_EG=false" >> $GITHUB_ENV

    - name: Start EG
      if: ${{ inputs.eg }}
      working-directory: ${{inputs.working-directory}}
      shell: ${{inputs.shell}}
      run: |
        echo "UFG_ON_EG=true" >> $GITHUB_ENV

    - name: Test and Report
      shell: ${{inputs.shell}}
      working-directory: ${{inputs.working-directory}}
      run: |
        echo "::group::Test"
        if [[ ${{inputs.module}} == *"coverage-selenium"* ]]; then
          cd coverage-tests;
          export APPLITOOLS_REPORT_ID="$(git rev-parse HEAD)-selenium"
          chmod +x ./generic_tests.sh;
          ./generic_tests.sh ${{ env.UFG_ON_EG }} "selenium"
        
          echo "::group::Report"
          if [[ ${{inputs.report}} == "deploy" ]]; then
            yarn report:prod-selenium;
          else
            yarn report:selenium;
          fi
          echo "::endgroup::"
        
        else
          if [[ ${{inputs.module}} == *"coverage-playwright"* ]]; then        
            cd coverage-tests;
            export APPLITOOLS_REPORT_ID="$(git rev-parse HEAD)-playwright"
            chmod +x ./generic_tests.sh;
            ./generic_tests.sh ${{ env.UFG_ON_EG }} "playwright"
            
            echo "::group::Report"
            if [[ ${{inputs.report}} == "deploy" ]]; then
              yarn report:prod-playwright;
            else
              yarn report:playwright;
            fi
            echo "::endgroup::"
        
          else
            export APPLITOOLS_REPORT_ID="$(git rev-parse HEAD)-java"
            mvn test -pl ${{inputs.module}} -e -X
            
            echo "::group::Report"
            if [ -d "${{inputs.report-dir}}/report" ]; then
              sh sendTestResults.sh
            else
              echo "No report was created"
            fi
            echo "::endgroup::"
        
          fi
        fi
        echo "::endgroup::Test"
      env:
        BUILD_DIR: ${{ inputs.report-dir }}